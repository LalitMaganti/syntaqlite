# AGENTS.md

This file provides guidance to AI agents such as Claude Code when working with code in this repository.

## Project Overview

syntaqlite is a suite of tools for tokenizing, parsing, and formatting SQLite SQL queries. Key principles:
- **Portable**: Plain C for maximum compatibility with SQLite environments
- **Fast**: High-performance for large/autogenerated files
- **Accurate**: Uses SQLite's own grammar (Lemon parser generator) for 100% compatibility
- **Extensible**: Designed to support SQLite dialects (databases that use SQLite as a base and add extensions)

The project uses autogenerated code from SQLite's grammar with selective human-written AST folding decisions to maintain resilience against upstream SQLite changes.

## Build System

Uses GN (meta-build) + Ninja with clang toolchain. C11 for C code, C++17 for tests.

### Initial Setup
```bash
tools/dev/install-build-deps                    # Download GN, Ninja, SQLite, GoogleTest
tools/dev/setup-all-configs --config mac_debug  # Generate build config
```

### Building
```bash
tools/dev/ninja -C out/mac_debug                # Build all targets (single developer)
tools/dev/build-lock -C out/mac_debug           # Build with file lock (multi-agent)
out/mac_debug/syntaqlite_unittests              # Run C++ unit tests
```

### Build Configurations
- `mac_debug`, `mac_release`, `linux_debug`, `linux_release`, `win_debug`, `win_release`
- Sanitizer variants: `mac_asan`, `mac_tsan`, `mac_msan`

Configure manually:
```bash
tools/dev/gn gen out/mac_debug --args="is_debug=true"
tools/dev/gn gen out/mac_asan --args="is_debug=true is_asan=true"
```

## Testing

### C++ Unit Tests (GoogleTest)
```bash
out/mac_debug/syntaqlite_unittests              # Run all tests
out/mac_debug/syntaqlite_unittests --gtest_filter="ClassName.test_name"
```

### AST Diff Tests (Python)
```bash
tools/tests/run-ast-diff-tests --binary out/mac_debug/ast_test
tools/tests/run-ast-diff-tests --filter select --jobs 4   # Filter + parallel
tools/tests/run-ast-diff-tests --rebaseline               # Print expected outputs
```

Test suites are auto-discovered by scanning `tests/ast_diff_tests/*.py` for `TestSuite` subclasses. No registration is needed — just create a new `.py` file.

## Code Style

### Include Paths
Only three forms allowed (enforced by `python/tools/check_includes.py`):
- `"src/..."` - internal source
- `"syntaqlite/..."` - public headers
- `<system>` - system headers

### Include Guards
Format: `SYNTAQLITE_<PATH>_H` (e.g., `SYNTAQLITE_SRC_LEXER_H`)
Fix with: `python/tools/fix_include_guards.py`

### Compiler Flags
Strict: `-Wall -Wextra -Werror`, no exceptions, no RTTI by default.

## Key Directories

- `src/` - C/C++ source (tokenizer, parser, shared defs)
- `include/` - Public headers
- `tests/ast_diff_tests/` - Python-based AST validation tests
- `python/tools/` - Development tooling
- `python/diff_tests/` - Test runner infrastructure
- `tools/dev/` - Executable wrappers for dev tools
- `third_party/src/sqlite/` - SQLite source (v3.51.2)
- `third_party/src/googletest/` - GoogleTest (v1.17.0)
- `docs/` - Design documentation (ethos.md, plan.md)

## Development Tools

| Tool | Purpose |
|------|---------|
| `python/tools/extract_sqlite.py` | Extract SQLite tokenizer and parser |
| `python/tools/check_includes.py` | Validate include paths |
| `python/tools/fix_include_guards.py` | Fix include guard format |
| `python/tools/update_gn_version.py` | Update GN binary |
| `tools/dev/build-lock` | Ninja wrapper with file lock for concurrent agents |

## Architecture Notes

The codebase is designed to minimize maintenance by:
1. Autogenerating parser code from SQLite's `parse.y` grammar
2. Human-written CST→AST folding decisions in isolation
3. Tools that detect when upstream SQLite grammar changes require attention

When SQLite updates their grammar, the `extract_sqlite.py` tool regenerates tokenizer and parser code, and only AST folding decisions may need manual updates.

### Dialect Extensibility

A key design goal is supporting SQLite-based dialects (e.g., databases that extend SQLite with additional keywords, functions, or syntax). Tools should:
- Accept extension grammar files (`.y` format) that get merged with SQLite's base grammar
- Support configurable prefixes for generated symbols and filenames
- Keep dialect-specific code isolated from the core SQLite extraction logic

This allows projects like libSQL, rqlite, or custom embedded databases to use syntaqlite with their extended syntax.
